name: 'Deploy on Sanity'

on:
  workflow_call:
    inputs:
      environment:
        description: 'The environment we are deploying'
        required: true
        type: string
      name:
        description: 'The name to use for the workflow step'
        required: true
        type: string
    secrets:
      SANITY_AUTH_TOKEN:
        required: true

concurrency:
  group: deploy-on-sanity-${{ github.workflow }}-${{ inputs.environment }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  statuses: write

jobs:
  deploy:
    name: ${{ inputs.name }}
    runs-on: ubuntu-latest

    steps:
      - name: 'ðŸ›’ Checkout Project'
        uses: actions/checkout@v5.0.0

      - name: 'ðŸ“© Restore node_modules cache'
        id: node_modules_cache
        uses: actions/cache@v4.3.0
        with:
          path: node_modules
          key: cache-node_modules-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            cache-node_modules-${{ runner.os }}-

      - name: 'ðŸ“¦ Setup Node.js'
        uses: actions/setup-node@v6.0.0
        with:
          # Due to https://github.com/actions/setup-node/issues/531 we need to enable corepack and yarn's cache manually
          # cache: 'yarn'
          node-version-file: .nvmrc

      - name: 'ðŸ”§ Enable Corepack'
        id: corepack
        run: |
          corepack enable
          echo "cache_dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      # Because the above step cannot automatically enable corepack, we need to manually track yarn's cache
      - name: 'ðŸ“© Restore yarn cache'
        id: yarn_cache
        uses: actions/cache@v4.3.0
        with:
          path: ${{ steps.corepack.outputs.cache_dir }}
          key: cache-yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            cache-yarn-${{ runner.os }}-

      - name: 'ðŸ¥¥ Setup Sanity'
        run: |
          npm install -g @sanity/cli

      - name: 'ðŸ§¶ Install dependencies'
        if: steps.node_modules_cache.outputs.cache-hit != 'true' || steps.yarn_cache.outputs.cache-hit != 'true'
        run: |
          yarn --immutable

      - name: 'ðŸš€ Deploying'
        id: deploy
        env:
          SANITY_AUTH_TOKEN: ${{ secrets.SANITY_AUTH_TOKEN }}
        run: |
          sanity deploy
