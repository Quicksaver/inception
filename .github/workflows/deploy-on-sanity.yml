name: Deploy on Sanity

on:
  workflow_call:
    inputs:
      environment:
        description: The environment we are deploying
        required: true
        type: string
      name:
        description: The name to use for the workflow step
        required: true
        type: string
      prefix:
        description: The prefix for this workflow run
        required: true
        type: string
      sha:
        description: The unique sha to attach the status to
        required: true
        type: string
    secrets:
      SANITY_AUTH_TOKEN:
        required: true

concurrency:
  group: deploy-on-sanity-${{ github.workflow }}-${{ inputs.environment }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  statuses: write

jobs:
  deploy:
    name: ${{ inputs.name }}
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ›’ Checkout Project
        uses: actions/checkout@v5.0.0

      - name: ðŸ“¦ Node.js Dependencies
        uses: ./.github/actions/nodejs-dependencies
        with:
          global_cache_key: ${{ inputs.environment }}-${{ inputs.prefix }}-sanity
          local_cache_key: ${{ inputs.environment }}-${{ inputs.prefix }}
          sha: ${{ inputs.sha }}

      - name: ðŸ¥¥ Setup Sanity
        run: |
          npm install -g @sanity/cli

      # @TODO separate datasets
      - name: ðŸš€ Deploy
        id: deploy
        env:
          SANITY_AUTH_TOKEN: ${{ secrets.SANITY_AUTH_TOKEN }}
        run: |
          sanity deploy
