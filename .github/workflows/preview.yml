name: Preview

on:
  pull_request:
    types:
      - labeled
      - opened
      - reopened
      - synchronize
  workflow_dispatch:
    inputs:
      environments:
        description: One of `production`
        required: false
        type: environment
      prefix:
        default: pr-
        description: The prefix identifier for this job; i.e. `pr-123`
        required: true

permissions:
  contents: read
  statuses: write

jobs:
  detect_context:
    name: ðŸŽ›
    uses: ./.github/workflows/detect-context-previews.yml
    with:
      # Not controlled via labels, always deploy the provided environments
      environments: ${{ inputs.environments || 'production' }}

  lint_check:
    name: ðŸ”¬
    uses: ./.github/workflows/lint-check.yml

  deploy_preview:
    if: ${{ needs.detect_context.outputs.environments != '[]' }}

    strategy:
      matrix:
        environment: ${{ fromJson(needs.detect_context.outputs.environments) }}

    name: ðŸš§ ${{ matrix.environment }}
    uses: ./.github/workflows/deploy-on-vercel.yml

    needs:
      - detect_context
      - lint_check

    secrets:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

    with:
      alias: ${{ needs.detect_context.outputs.prefix }}--${{ matrix.environment }}--zinc-inception.vercel.app
      context: preview
      environment: ${{ matrix.environment }}
      name: Deploy
      prefix: ${{ needs.detect_context.outputs.prefix }}
      sha: ${{ needs.detect_context.outputs.sha }}
