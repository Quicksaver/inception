name: 'Preview'

on:
  pull_request:
    types:
      - labeled
      - opened
      - reopened
      - synchronize
  workflow_dispatch:
    inputs:
      prefix:
        description: 'The prefix identifier for this job; i.e. `pr-123`'
        required: true
        default: 'pr-'

permissions:
  contents: read
  statuses: write

jobs:
  detect_context:
    uses: ./.github/workflows/detect-context-previews.yml

  lint_check:
    uses: ./.github/workflows/lint-check.yml

  deploy_preview:
    strategy:
      matrix:
        environment: ${{ fromJson(needs.detect_context.outputs.enabled_builds) }}

    uses: ./.github/workflows/deploy-on-vercel.yml

    needs:
      - detect_context
      - lint_check

    secrets:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

    with:
      alias: ${{ needs.detect_context.outputs.prefix }}--${{ matrix.environment }}--zinc-inception.vercel.app
      context: preview
      environment: ${{ matrix.environment }}
      name: 'ðŸš§ Deploy'
      prefix: ${{ needs.detect_context.outputs.prefix }}
      sha: ${{ needs.detect_context.outputs.sha }}
