name: Detect Context Previews

on:
  workflow_call:
    inputs:
      app:
        description: The app we are deploying. Set only if this is monorepo with multiple apps.
        required: false
        type: string
      environments:
        default: ''
        description: Comma separated list of which preview environment builds should be triggered. If empty, will auto-detect based on PR labels.
        required: false
        type: string
    outputs:
      environments:
        description: Which preview builds should be triggered
        value: ${{ jobs.detect_context.outputs.environments }}
      prefix:
        description: Prefix for the preview alias
        value: ${{ jobs.detect_context.outputs.prefix }}
      ref_name:
        description: The name of the branch or tag attached to this run
        value: ${{ jobs.detect_context.outputs.ref_name }}
      sha:
        description: The unique sha to attach the status to
        value: ${{ jobs.detect_context.outputs.sha }}

permissions:
  contents: read

jobs:
  detect_context:
    name: Detect Context
    runs-on: ubuntu-latest

    outputs:
      environments: ${{ steps.check_labels.outputs.result }}
      prefix: ${{ steps.variables_prepare.outputs.prefix }}
      ref_name: ${{ steps.variables_prepare.outputs.ref_name }}
      sha: ${{ steps.variables_prepare.outputs.sha }}

    steps:
      - name: ðŸ›’ Checkout Project
        uses: actions/checkout@v5.0.0

      - name: ðŸ“¦ Detect Package Manager
        id: package_manager
        uses: ./.github/actions/detect-nodejs-package-manager

      - name: ðŸ·ï¸ Check Labels
        uses: actions/github-script@v8.0.0
        id: check_labels
        with:
          result-encoding: string
          script: |
            if ('${{ inputs.environments }}') {
              return JSON.stringify(
                '${{ inputs.environments }}'
                  .split(',')
                  .map(s => s.trim())
                  .filter(Boolean),
              );
            }

            const labels = context.payload.pull_request.labels.map(label => label.name);
            const hasApp = !'${{ inputs.app }}' || labels.includes('run-app-${{ inputs.app }}');
            const environments = labels
              .filter(label => label.startsWith('run-env-'))
              .map(label => label.substring(8));

            if (context.payload.action === 'labeled') {
              // If adding an environment label, we need to check if the app label is also present
              // in order to run the corresponding build.
              if (context.payload.label.name.startsWith('run-env-') && hasApp) {
                return JSON.stringify([ context.payload.label.name.substring(8) ]);
              }

              // If adding an app label, we need to check if the environment labels are also
              // present, same as above.
              if ('${{ inputs.app }}' && context.payload.label.name === 'run-app-${{ inputs.app }}') {
                return JSON.stringify(environments);
              }

              // Any other label added, don't run anything.
              return '[]';
            }

            // From here on out, it's PR opened, reopened, or synchronize events.

            // If PR has the app label, we can run the corresponding environment builds.
            if (hasApp) {
              return JSON.stringify(environments);
            }

            // No labels found that would trigger any build for this PR.
            return '[]';

      - name: ðŸŽ› Environments Variables Prepare
        id: variables_prepare
        run: |
          # Check the trigger for this Action
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Grab variables from Event Inputs
            PREFIX="${{ github.event.inputs.prefix }}"
            REF_NAME="${{ github.ref_name }}"
            SHA="${{ github.sha }}"

          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            PREFIX="pr-${{ github.event.number }}"
            REF_NAME="${{ github.head_ref }}"
            SHA="${{ github.event.pull_request.head.sha }}"
          fi

          echo "==[ CONTEXT INFORMATION ]============="
          echo "Environments    : ${{ steps.check_labels.outputs.result }}"
          echo "Event Name      : ${{ github.event_name }}"
          echo "Package Manager : ${{ steps.package_manager.outputs.package_manager || 'unknown' }}"
          echo "Prefix          : ${PREFIX}"
          echo "Ref Name        : ${REF_NAME}"
          echo "SHA             : ${SHA}"
          echo "======================================"

          echo "prefix=${PREFIX}" >> $GITHUB_OUTPUT
          echo "ref_name=${REF_NAME}" >> $GITHUB_OUTPUT
          echo "sha=${SHA}" >> $GITHUB_OUTPUT
