name: 'Detect Context Previews'

on:
  workflow_call:
    # inputs:
    #   app:
    #     description: 'The app we are deploying'
    #     required: true
    #     type: string
    outputs:
      enabled_builds:
        description: 'Which preview builds should be triggered'
        value: ${{ jobs.detect_context.outputs.enabled_builds }}
      prefix:
        description: 'Prefix for the preview alias'
        value: ${{ jobs.detect_context.outputs.prefix }}
      ref_name:
        description: 'The name of the branch or tag attached to this run'
        value: ${{ jobs.detect_context.outputs.ref_name }}
      sha:
        description: 'The unique sha to attach the status to'
        value: ${{ jobs.detect_context.outputs.sha }}

permissions:
  contents: read

jobs:
  detect_context:
    name: 'ðŸŽ› Detect Context'
    runs-on: ubuntu-latest

    outputs:
      enabled_builds: ${{ steps.check_labels.outputs.result }}
      prefix: ${{ steps.variables_prepare.outputs.prefix }}
      ref_name: ${{ steps.variables_prepare.outputs.ref_name }}
      sha: ${{ steps.variables_prepare.outputs.sha }}

    steps:
      - name: 'ðŸ›’ Checkout Project'
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/checkout@v5.0.0

      - name: âœ… Check Labels
        uses: actions/github-script@v8.0.0
        id: check_labels
        with:
          result-encoding: string
          script: |
            // For now we always deploy production previews, remove this section to control via
            // labels
            return 'production';

            // Manual dispatches always run
            if (context.eventName === 'workflow_dispatch') {
              return 'production,staging';
            }

            const labels = context.payload.pull_request.labels.map(label => label.name);
            const hasApp = labels.includes('app-${{ inputs.app }}');
            const hasProduction = labels.includes('environment-production');
            const hasStaging = labels.includes('environment-staging');

            if (context.payload.action === 'labeled') {
              // No matter what labels we add, if the PR already has `ready`, we don't need to
              // trigger the builds as they have already run before when it was added.
              if (context.payload.label.name !== 'ready' && labels.includes('ready')) {
                return '';
              }

              if (context.payload.label.name === 'ready') {
                // When adding the `ready` label, we can skip any individual app builds that have
                // already run for this app.
                if (hasApp) {
                  return [
                    !hasProduction ? 'production' : '',
                    !hasStaging ? 'staging' : '',
                  ]
                    .filter(Boolean)
                    .join(',');
                }

                // Otherwise we assume we have no previous builds for this app, so run them all.
                return 'production,staging';
              }

              // If adding an environment label, we need to check if the app label is also present
              // in order to run the corresponding build.
              if (context.payload.label.name.startsWith('environment-') && hasApp) {
                return context.payload.label.name.substring(12);
              }

              // If adding an app label, we need to check if the environment labels are also
              // present, same as above.
              if (context.payload.label.name === 'app-${{ inputs.app }}') {
                return [
                  hasProduction ? 'production' : '',
                  hasStaging ? 'staging' : '',
                ]
                  .filter(Boolean)
                  .join(',');
              }

              // Any other label added, don't run anything.
              return '';
            }

            // From here on out, it's PR opened, reopened, or synchronize events.

            // If PR has `ready`, we can run both production and staging builds.
            if (labels.includes('ready')) {
              return 'production,staging';
            }

            // If PR has the app label, we can run the corresponding environment builds.
            if (labels.includes('app-${{ inputs.app }}')) {
              return [
                  hasProduction ? 'production' : '',
                  hasStaging ? 'staging' : '',
                ]
                  .filter(Boolean)
                  .join(',');
            }

            // No labels found that would trigger any build for this PR.
            return '';

      - name: 'ðŸŽ› Environments Variables Prepare'
        id: variables_prepare
        run: |
          # Check the trigger for this Action
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Grab variables from Event Inputs
            PREFIX="${{ github.event.inputs.prefix }}"
            REF_NAME="${{ github.ref_name }}"
            SHA="${{ github.sha }}"

          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            PREFIX="pr-${{ github.event.number }}"
            REF_NAME="${{ github.head_ref }}"
            SHA="${{ github.event.pull_request.head.sha }}"
          fi

          echo "==[ CONTEXT INFORMATION ]============="
          echo "Event Name : ${{ github.event_name }}"
          echo "Prefix     : ${PREFIX}"
          echo "Ref Name   : ${REF_NAME}"
          echo "SHA        : ${SHA}"
          echo "======================================"

          echo "prefix=${PREFIX}" >> $GITHUB_OUTPUT
          echo "ref_name=${REF_NAME}" >> $GITHUB_OUTPUT
          echo "sha=${SHA}" >> $GITHUB_OUTPUT

          echo "Variables exported through GITHUB_OUTPUT"
