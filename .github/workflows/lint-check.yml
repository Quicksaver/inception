name: Lint Check

on:
  workflow_call:
    inputs:
      working_directory:
        default: .
        description: The working directory for the job
        type: string

concurrency:
  cancel-in-progress: true
  group: lint-check-${{ github.workflow }}-${{ inputs.working_directory }}-${{ github.event.pull_request.number || github.ref }}

permissions:
  contents: read
  statuses: write

jobs:
  checks:
    name: Check & Pre-Cache
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}

    outputs:
      eslint: ${{ steps.checks.outputs.eslint }}
      phpcsfixer: ${{ steps.checks.outputs.phpcsfixer }}
      run_script: ${{ steps.package_manager.outputs.run_script }}
      stylelint: ${{ steps.checks.outputs.stylelint }}
      tsc: ${{ steps.checks.outputs.tsc }}

    steps:
      - name: ðŸ›’ Checkout Project
        uses: actions/checkout@v5.0.0

      - name: ðŸ“¦ Detect Package Manager
        id: package_manager
        uses: ./.github/actions/detect-nodejs-package-manager

      - name: ðŸŽ› Check For Tests
        id: checks
        run: |
          ESLINT=false
          PHPCSFIXER=false
          STYLELINT=false
          TSC=false

          if [ -f "package.json" ]; then
            if grep -q "lint:eslint" package.json; then
              ESLINT=true
            fi

            if grep -q "lint:stylelint" package.json; then
              STYLELINT=true
            fi

            if grep -q "lint:tsc" package.json; then
              TSC=true
            fi
          fi

          if [ -f "composer.json" ] && grep -q "php-cs-fixer" composer.json; then
            PHPCSFIXER=true
          fi

          echo "eslint=${ESLINT}" >> $GITHUB_OUTPUT
          echo "phpcsfixer=${PHPCSFIXER}" >> $GITHUB_OUTPUT
          echo "stylelint=${STYLELINT}" >> $GITHUB_OUTPUT
          echo "tsc=${TSC}" >> $GITHUB_OUTPUT

      # Install dependencies if any lint checks are going to run, this will ensure cache hits for the later jobs,
      # speeding up the overall workflow (i.e. one install here vs possible multiple installs, once for each job)
      - name: ðŸ“© Pre-Cache Node.js Dependencies
        if: ${{ steps.checks.outputs.eslint == 'true' || steps.checks.outputs.stylelint == 'true' || steps.checks.outputs.tsc == 'true' }}
        uses: ./.github/actions/nodejs-dependencies
        with:
          include_dev_dependencies: true
          local_cache_key: lint_check
          working_directory: ${{ inputs.working_directory }}

  eslint:
    name: ESLint
    if: ${{ needs.checks.outputs.eslint == 'true' }}
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}

    needs:
      - checks

    steps:
      - name: ðŸ›’ Checkout Project
        uses: actions/checkout@v5.0.0

      - name: ðŸ“¦ Node.js Dependencies
        uses: ./.github/actions/nodejs-dependencies
        with:
          include_dev_dependencies: true
          local_cache_key: lint_check
          working_directory: ${{ inputs.working_directory }}

      - name: ðŸ§¬ TypeGen
        uses: ./.github/actions/typegen
        with:
          working_directory: ${{ inputs.working_directory }}

      - name: ðŸ”¬ Run ESLint check
        run: |
          ${{ needs.checks.outputs.run_script }} lint:eslint

  phpcsfixer:
    name: PHP CS Fixer
    if: ${{ needs.checks.outputs.phpcsfixer == 'true' }}
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}

    needs:
      - checks

    steps:
      - name: ðŸ›’ Checkout Project
        uses: actions/checkout@v5.0.0

      - name: ðŸ“¦ Composer Dependencies
        uses: ./.github/actions/php-composer
        with:
          local_cache_key: lint_check
          working_directory: ${{ inputs.working_directory }}

      - name: ðŸ”¬ Run PHP CS Fixer check
        run: |
          ./vendor/bin/php-cs-fixer fix lib --dry-run --diff

  stylelint:
    name: Stylelint
    if: ${{ needs.checks.outputs.stylelint == 'true' }}
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}

    needs:
      - checks

    steps:
      - name: ðŸ›’ Checkout Project
        uses: actions/checkout@v5.0.0

      - name: ðŸ“¦ Node.js Dependencies
        uses: ./.github/actions/nodejs-dependencies
        with:
          include_dev_dependencies: true
          local_cache_key: lint_check
          working_directory: ${{ inputs.working_directory }}

      - name: ðŸ”¬ Run Stylelint check
        run: |
          ${{ needs.checks.outputs.run_script }} lint:stylelint

  tsc:
    name: Typescript
    if: ${{ needs.checks.outputs.tsc == 'true' }}
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}

    needs:
      - checks

    steps:
      - name: ðŸ›’ Checkout Project
        uses: actions/checkout@v5.0.0

      - name: ðŸ“¦ Node.js Dependencies
        uses: ./.github/actions/nodejs-dependencies
        with:
          include_dev_dependencies: true
          local_cache_key: lint_check
          working_directory: ${{ inputs.working_directory }}

      - name: ðŸ§¬ TypeGen
        uses: ./.github/actions/typegen
        with:
          working_directory: ${{ inputs.working_directory }}

      - name: ðŸ”¬ Run Typescript check
        run: |
          ${{ needs.checks.outputs.run_script }} lint:tsc
