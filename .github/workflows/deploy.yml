name: 'Deploy'

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        type: environment
        description: 'One of `production`'
        required: true
        default: 'production'

permissions:
  contents: read
  statuses: write

jobs:
  detect_context:
    uses: ./.github/workflows/detect-context-environments.yml

  lint_check:
    uses: ./.github/workflows/lint-check.yml

  deploy_vercel:
    uses: ./.github/workflows/deploy-on-vercel.yml

    needs:
      - detect_context
      - lint_check

    secrets:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

    with:
      alias: ${{ needs.detect_context.outputs.environment == 'production' && 'zinc-inception.vercel.app' || '' }}
      context: ${{ needs.detect_context.outputs.environment == 'production' && 'production' || 'preview' }}
      environment: ${{ needs.detect_context.outputs.environment }}
      name: 'ðŸš€ Deploy to Vercel'
      prefix: environment
      sha: ${{ needs.detect_context.outputs.sha }}

  # @TODO separate datasets for staging and production
  deploy_sanity:
    uses: ./.github/workflows/deploy-on-sanity.yml

    needs:
      - detect_context
      - lint_check

    secrets:
      SANITY_AUTH_TOKEN: ${{ secrets.SANITY_AUTH_TOKEN }}

    with:
      environment: ${{ needs.detect_context.outputs.environment }}
      name: 'ðŸš€ Deploy to Sanity'
